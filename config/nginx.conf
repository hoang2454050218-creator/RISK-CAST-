# RISKCAST V2 — Nginx Configuration
# Production-ready with SSE support
#
# Key: proxy_buffering off for SSE endpoints

upstream riskcast_v2_api {
    server riskcast-v2:8002;
}

upstream riskcast_web {
    server riskcast-web:80;
}

server {
    listen 80;
    server_name app.riskcast.io;

    # ── Frontend (static assets) ─────────────────────────────
    location / {
        proxy_pass http://riskcast_web;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # ── API (standard endpoints) ─────────────────────────────
    location /api/ {
        proxy_pass http://riskcast_v2_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }

    # ── SSE endpoints — MUST disable buffering ───────────────
    # Chat streaming + Event stream + Brief generation
    location ~ ^/api/v1/(chat/message|events/stream|briefs/) {
        proxy_pass http://riskcast_v2_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Connection '';

        # CRITICAL for SSE:
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding off;

        # Long timeout for streaming
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Disable gzip for SSE (breaks streaming)
        proxy_set_header Accept-Encoding '';
    }

    # ── Health check ─────────────────────────────────────────
    location /health {
        proxy_pass http://riskcast_v2_api;
        proxy_connect_timeout 3s;
        proxy_read_timeout 5s;
    }

    # ── Security headers ─────────────────────────────────────
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy strict-origin-when-cross-origin always;

    # ── Gzip ─────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml;

    # ── File upload limit (CSV imports) ──────────────────────
    client_max_body_size 50m;
}
