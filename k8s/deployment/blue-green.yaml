# RISKCAST Blue-Green Deployment Configuration
#
# Alternative to canary deployment for zero-downtime releases.
# Useful for major version changes where gradual rollout isn't appropriate.
#
# Addresses audit gap: D3.4 Zero-Downtime Ops
---
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: riskcast-blue-green
  namespace: riskcast
  labels:
    app: riskcast
    deployment-strategy: blue-green
spec:
  replicas: 5
  revisionHistoryLimit: 3
  
  selector:
    matchLabels:
      app: riskcast
  
  template:
    metadata:
      labels:
        app: riskcast
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    spec:
      containers:
        - name: riskcast
          image: riskcast/riskcast:latest
          ports:
            - containerPort: 8000
          
          readinessProbe:
            httpGet:
              path: /health/ready
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
          
          livenessProbe:
            httpGet:
              path: /health/live
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 10
          
          resources:
            requests:
              cpu: "500m"
              memory: "512Mi"
            limits:
              cpu: "2000m"
              memory: "2Gi"
  
  # ============================================================================
  # BLUE-GREEN STRATEGY
  # ============================================================================
  strategy:
    blueGreen:
      # Active service receives production traffic
      activeService: riskcast-active
      
      # Preview service for testing before promotion
      previewService: riskcast-preview
      
      # Automatically promote after analysis passes
      autoPromotionEnabled: true
      
      # Seconds to wait after switching before scaling down old version
      scaleDownDelaySeconds: 300  # 5 minutes
      
      # Seconds to wait for preview to be ready
      previewReplicaCount: 3
      
      # Run analysis before promotion
      prePromotionAnalysis:
        templates:
          - templateName: blue-green-analysis
        args:
          - name: service-name
            value: riskcast-preview
      
      # Run analysis after promotion
      postPromotionAnalysis:
        templates:
          - templateName: post-promotion-analysis
        args:
          - name: service-name
            value: riskcast-active

---
# ============================================================================
# ANALYSIS TEMPLATE - Blue-Green Pre-Promotion
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: blue-green-analysis
  namespace: riskcast
spec:
  args:
    - name: service-name
  
  metrics:
    # Error rate check
    - name: error-rate
      interval: 30s
      count: 10
      successCondition: result[0] < 0.01
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            sum(rate(http_requests_total{service="{{ args.service-name }}",status=~"5.."}[2m]))
            /
            sum(rate(http_requests_total{service="{{ args.service-name }}"}[2m]))
    
    # Latency check
    - name: latency-p99
      interval: 30s
      count: 10
      successCondition: result[0] < 2
      failureLimit: 3
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{service="{{ args.service-name }}"}[2m]))
              by (le)
            )
    
    # Health check
    - name: health-check
      interval: 30s
      count: 10
      successCondition: result[0] == 1
      failureLimit: 2
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            up{service="{{ args.service-name }}"}

---
# ============================================================================
# ANALYSIS TEMPLATE - Post-Promotion Validation
# ============================================================================
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: post-promotion-analysis
  namespace: riskcast
spec:
  args:
    - name: service-name
  
  metrics:
    # Verify production is healthy after promotion
    - name: post-promotion-health
      interval: 1m
      count: 5
      successCondition: result[0] < 0.01
      failureLimit: 2
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            sum(rate(http_requests_total{service="{{ args.service-name }}",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{service="{{ args.service-name }}"}[5m]))
    
    # Check decision flow is working
    - name: decisions-flowing
      interval: 2m
      count: 3
      successCondition: result[0] > 0
      failureLimit: 1
      provider:
        prometheus:
          address: http://prometheus.monitoring:9090
          query: |
            sum(increase(decisions_total{service="{{ args.service-name }}"}[5m]))

---
# ============================================================================
# SERVICES
# ============================================================================
apiVersion: v1
kind: Service
metadata:
  name: riskcast-active
  namespace: riskcast
  labels:
    app: riskcast
    role: active
spec:
  ports:
    - port: 8000
      targetPort: 8000
      name: http
  selector:
    app: riskcast
    # Managed by Argo Rollouts

---
apiVersion: v1
kind: Service
metadata:
  name: riskcast-preview
  namespace: riskcast
  labels:
    app: riskcast
    role: preview
spec:
  ports:
    - port: 8000
      targetPort: 8000
      name: http
  selector:
    app: riskcast
    # Managed by Argo Rollouts
